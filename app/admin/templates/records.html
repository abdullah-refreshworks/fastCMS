{% extends "base.html" %}

{% block title %}Records{% endblock %}

{% block content %}
<div x-data="recordsData('{{ collection_name }}')" x-init="await loadCollection(); await loadRecords()">
    <div class="px-4 sm:px-0 flex justify-between items-start">
        <div>
            <div class="flex items-center space-x-3">
                <a href="/admin/collections" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-3xl font-bold text-gray-900">
                    <span x-text="collection?.name || '{{ collection_name }}'"></span> Records
                </h1>
            </div>
            <p class="mt-2 text-sm text-gray-700">
                Manage records in this collection
            </p>
        </div>
        <div class="flex space-x-3">
            <a
                href="/admin/collections/{{ collection_name }}/api"
                class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
            >
                <i class="fas fa-code mr-2"></i>
                View API
            </a>
            <!-- Only show Create button for non-view collections -->
            <a
                x-show="collection?.type !== 'view'"
                :href="`/admin/collections/{{ collection_name }}/records/new`"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700"
            >
                <i class="fas fa-plus mr-2"></i>
                Create Record
            </a>
            <!-- Info badge for view collections -->
            <span
                x-show="collection?.type === 'view'"
                class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-md"
            >
                <i class="fas fa-info-circle mr-2"></i>
                View Collection (Read-Only)
            </span>
        </div>
    </div>

    <!-- Records Table -->
    <div class="mt-6 bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    Total: <span class="font-medium text-gray-900" x-text="pagination.total"></span> records
                </div>
                <div class="flex items-center space-x-2">
                    <button @click="prevPage" :disabled="pagination.page === 1"
                        class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">
                        Previous
                    </button>
                    <span class="text-sm text-gray-600">
                        Page <span x-text="pagination.page"></span> of <span x-text="pagination.total_pages"></span>
                    </span>
                    <button @click="nextPage" :disabled="pagination.page >= pagination.total_pages"
                        class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">
                        Next
                    </button>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <template x-for="field in collection?.schema?.slice(0, 5)" :key="field.name">
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="field.name"></th>
                        </template>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="record in records" :key="record.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <code class="text-xs text-gray-600" x-text="record.id.substring(0, 8) + '...'"></code>
                            </td>
                            <template x-for="field in collection?.schema?.slice(0, 5)" :key="field.name">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span x-text="formatFieldValue(record.data[field.name], field.type)"></span>
                                </td>
                            </template>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <span x-text="new Date(record.created).toLocaleDateString()"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <!-- View collections: only show View button -->
                                <template x-if="collection?.type === 'view'">
                                    <span class="text-gray-500 italic text-xs">Read-only</span>
                                </template>
                                <!-- Regular collections: show all actions -->
                                <template x-if="collection?.type !== 'view'">
                                    <div>
                                        <a :href="`/admin/collections/{{ collection_name }}/records/${record.id}`"
                                           class="text-indigo-600 hover:text-indigo-900 mr-3">
                                            View
                                        </a>
                                        <a :href="`/admin/collections/{{ collection_name }}/records/${record.id}/edit`"
                                           class="text-gray-600 hover:text-gray-900 mr-3">
                                            Edit
                                        </a>
                                        <button @click="deleteRecord(record)" class="text-red-600 hover:text-red-900">
                                            Delete
                                        </button>
                                    </div>
                                </template>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="records.length === 0">
                        <td :colspan="(collection?.schema?.length || 0) + 3" class="px-6 py-12 text-center">
                            <div class="text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-4 block"></i>
                                <template x-if="collection?.type === 'view'">
                                    <p class="mb-2">No results from this view query</p>
                                </template>
                                <template x-if="collection?.type !== 'view'">
                                    <div>
                                        <p class="mb-2">No records yet</p>
                                        <a :href="`/admin/collections/{{ collection_name }}/records/new`"
                                           class="text-indigo-600 hover:text-indigo-500">
                                            Create your first record
                                        </a>
                                    </div>
                                </template>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function recordsData(collectionName) {
        return {
            collection: null,
            records: [],
            pagination: {
                page: 1,
                per_page: 20,
                total: 0,
                total_pages: 0
            },

            async loadCollection() {
                try {
                    // Use the name endpoint to get collection by name
                    this.collection = await apiRequest(`/collections/name/${collectionName}`);
                    console.log('Loaded collection:', this.collection.name, 'Type:', this.collection.type);
                } catch (error) {
                    console.error('Failed to load collection:', error);
                }
            },

            async loadRecords() {
                try {
                    // Wait for collection to be loaded first
                    if (!this.collection) {
                        console.warn('Collection not loaded yet, waiting...');
                        await this.loadCollection();
                    }

                    // Use different endpoint for view collections
                    let endpoint;
                    if (this.collection?.type === 'view') {
                        console.log('Loading view collection records from /views endpoint');
                        endpoint = `/views/${collectionName}/records?page=${this.pagination.page}&per_page=${this.pagination.per_page}`;
                    } else {
                        console.log('Loading regular collection records');
                        endpoint = `/${collectionName}/records?page=${this.pagination.page}&per_page=${this.pagination.per_page}`;
                    }

                    const data = await apiRequest(endpoint);
                    this.records = data.items;
                    this.pagination = {
                        page: data.page,
                        per_page: data.per_page,
                        total: data.total,
                        total_pages: data.total_pages
                    };
                } catch (error) {
                    console.error('Failed to load records:', error);
                    showToast('Failed to load records', 'error');
                }
            },

            async deleteRecord(record) {
                const confirmed = confirm(`Delete this record? This action cannot be undone.`);
                if (!confirmed) return;

                try {
                    await apiRequest(`/${collectionName}/records/${record.id}`, {
                        method: 'DELETE'
                    });
                    showToast('Record deleted successfully', 'success');
                    await this.loadRecords();
                } catch (error) {
                    console.error('Failed to delete record:', error);
                }
            },

            formatFieldValue(value, type) {
                if (value === null || value === undefined) return '—';
                if (type === 'bool') return value ? '✓' : '✗';
                if (type === 'json') return JSON.stringify(value).substring(0, 30) + '...';
                if (typeof value === 'string' && value.length > 50) {
                    return value.substring(0, 50) + '...';
                }
                return value;
            },

            async nextPage() {
                if (this.pagination.page < this.pagination.total_pages) {
                    this.pagination.page++;
                    await this.loadRecords();
                }
            },

            async prevPage() {
                if (this.pagination.page > 1) {
                    this.pagination.page--;
                    await this.loadRecords();
                }
            }
        };
    }
</script>
{% endblock %}
