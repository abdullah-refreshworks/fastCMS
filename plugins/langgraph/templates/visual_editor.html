<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Workflow Editor - LangGraph</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    [x-cloak] { display: none !important; }

    #canvas {
      background-image:
        linear-gradient(rgba(0,0,0,.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,.03) 1px, transparent 1px);
      background-size: 20px 20px;
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .node {
      position: absolute;
      cursor: move;
      user-select: none;
      transition: box-shadow 0.2s;
    }

    .node:hover {
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .node.dragging {
      opacity: 0.8;
      z-index: 1000;
    }

    .connection-port {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: crosshair;
      transition: all 0.2s;
    }

    .connection-port:hover {
      transform: scale(1.5);
    }

    .connection-line {
      position: absolute;
      pointer-events: none;
      z-index: 0;
    }

    svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
  </style>
</head>

<body class="h-screen overflow-hidden bg-gray-50">
  <div class="h-full flex flex-col" x-data="visualEditor" @mousemove="onMouseMove" @mouseup="onMouseUp">
    <!-- Toolbar -->
    <div class="bg-white border-b px-4 py-3 flex items-center justify-between shadow-sm z-10">
      <div class="flex items-center space-x-4">
        <a href="/admin/langgraph" class="text-gray-600 hover:text-gray-900">
          <i class="fas fa-arrow-left text-lg"></i>
        </a>
        <input
          type="text"
          x-model="workflow.name"
          class="text-xl font-bold border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded px-2"
          placeholder="Untitled Workflow"
        />
      </div>

      <div class="flex items-center space-x-2">
        <button
          @click="clearCanvas()"
          class="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
          title="Clear canvas"
        >
          <i class="fas fa-trash"></i>
        </button>
        <button
          @click="saveWorkflow()"
          class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center"
        >
          <i class="fas fa-save mr-2"></i>Save
        </button>
        <button
          @click="executeWorkflow()"
          :disabled="nodes.length === 0"
          :class="nodes.length === 0 ? 'opacity-50 cursor-not-allowed' : ''"
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center"
        >
          <i class="fas fa-play mr-2"></i>Run
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
      <!-- Sidebar -->
      <div class="w-64 bg-white border-r p-4 overflow-y-auto z-10">
        <h3 class="text-lg font-bold mb-4">Node Library</h3>

        <div class="space-y-2">
          <button
            @click="addNode('llm', 100, 100)"
            class="w-full p-3 bg-purple-50 border-2 border-purple-200 rounded-lg hover:bg-purple-100 flex items-center"
          >
            <div class="w-10 h-10 bg-purple-500 text-white rounded flex items-center justify-center mr-3">
              <i class="fas fa-brain"></i>
            </div>
            <div class="text-left">
              <div class="font-semibold text-sm">LLM Node</div>
              <div class="text-xs text-gray-600">GPT AI</div>
            </div>
          </button>

          <button
            @click="addNode('function', 100, 100)"
            class="w-full p-3 bg-blue-50 border-2 border-blue-200 rounded-lg hover:bg-blue-100 flex items-center"
          >
            <div class="w-10 h-10 bg-blue-500 text-white rounded flex items-center justify-center mr-3">
              <i class="fas fa-code"></i>
            </div>
            <div class="text-left">
              <div class="font-semibold text-sm">Function</div>
              <div class="text-xs text-gray-600">Python</div>
            </div>
          </button>

          <button
            @click="addNode('start', 100, 100)"
            class="w-full p-3 bg-green-50 border-2 border-green-200 rounded-lg hover:bg-green-100 flex items-center"
          >
            <div class="w-10 h-10 bg-green-500 text-white rounded flex items-center justify-center mr-3">
              <i class="fas fa-play"></i>
            </div>
            <div class="text-left">
              <div class="font-semibold text-sm">Start</div>
              <div class="text-xs text-gray-600">Entry</div>
            </div>
          </button>

          <button
            @click="addNode('end', 100, 100)"
            class="w-full p-3 bg-red-50 border-2 border-red-200 rounded-lg hover:bg-red-100 flex items-center"
          >
            <div class="w-10 h-10 bg-red-500 text-white rounded flex items-center justify-center mr-3">
              <i class="fas fa-stop"></i>
            </div>
            <div class="text-left">
              <div class="font-semibold text-sm">End</div>
              <div class="text-xs text-gray-600">Exit</div>
            </div>
          </button>
        </div>

        <div class="mt-6 p-3 bg-blue-50 rounded text-xs text-gray-700">
          <strong>How to use:</strong>
          <ul class="mt-2 space-y-1">
            <li>• Click to add nodes</li>
            <li>• Drag nodes to move</li>
            <li>• Drag from ⚪ to connect</li>
            <li>• Click node to configure</li>
            <li>• Right-click to delete</li>
          </ul>
        </div>
      </div>

      <!-- Canvas -->
      <div class="flex-1 relative">
        <div id="canvas" class="absolute inset-0">
          <!-- SVG for connections -->
          <svg id="connections-svg">
            <template x-for="edge in edges" :key="edge.id">
              <g>
                <path
                  :d="getEdgePath(edge)"
                  stroke="#94a3b8"
                  stroke-width="2"
                  fill="none"
                  :marker-end="'url(#arrowhead)'"
                />
              </g>
            </template>
            <defs>
              <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                <polygon points="0 0, 10 3, 0 6" fill="#94a3b8" />
              </marker>
            </defs>
          </svg>

          <!-- Drawing line -->
          <svg x-show="isDrawingConnection" id="temp-line-svg">
            <line
              :x1="connectionStart.x"
              :y1="connectionStart.y"
              :x2="mousePosition.x"
              :y2="mousePosition.y"
              stroke="#6366f1"
              stroke-width="2"
              stroke-dasharray="5,5"
            />
          </svg>

          <!-- Nodes -->
          <template x-for="node in nodes" :key="node.id">
            <div
              :id="'node-' + node.id"
              class="node bg-white rounded-lg shadow-lg border-2"
              :class="getNodeBorderColor(node.node_type)"
              :style="`left: ${node.position_x}px; top: ${node.position_y}px; width: 220px;`"
              @mousedown="startDrag($event, node)"
              @click="if (!hasDragged) openNodeConfig(node)"
              @contextmenu.prevent="deleteNode(node)"
            >
              <!-- Node Header -->
              <div class="p-3 border-b flex items-center justify-between">
                <div class="flex items-center flex-1 min-w-0">
                  <div
                    class="w-8 h-8 rounded flex items-center justify-center text-white mr-2 flex-shrink-0"
                    :class="getNodeBgColor(node.node_type)"
                  >
                    <i :class="'fas fa-' + getNodeIcon(node.node_type)"></i>
                  </div>
                  <input
                    type="text"
                    x-model="node.label"
                    @click.stop
                    @mousedown.stop
                    class="font-semibold text-sm border-none focus:outline-none focus:ring-1 focus:ring-indigo-500 rounded px-1 flex-1 min-w-0"
                    placeholder="Label"
                  />
                </div>
                <button
                  @click.stop="openNodeConfig(node)"
                  class="text-gray-400 hover:text-indigo-600 ml-2"
                  title="Configure"
                >
                  <i class="fas fa-cog text-sm"></i>
                </button>
              </div>

              <!-- Node Body -->
              <div class="p-2 text-xs text-gray-600">
                <div class="font-mono text-xs" x-text="node.node_type"></div>
              </div>

              <!-- Connection Ports -->
              <div class="flex justify-between items-center px-3 pb-2">
                <!-- Input Port -->
                <div
                  @mouseup.stop="endConnection(node)"
                  class="connection-port bg-gray-300 hover:bg-green-500"
                  :data-node-id="node.id"
                  title="Input"
                ></div>

                <!-- Output Port -->
                <div
                  @mousedown.stop="startConnection($event, node)"
                  class="connection-port bg-gray-300 hover:bg-blue-500"
                  :data-node-id="node.id"
                  title="Output - drag to connect"
                ></div>
              </div>
            </div>
          </template>

          <!-- Empty state -->
          <div x-show="nodes.length === 0" class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="text-center">
              <i class="fas fa-project-diagram text-6xl text-gray-300 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-600 mb-2">Click nodes to add them</h3>
              <p class="text-gray-500">Drag to move • Drag from ⚪ to connect</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Config Modal -->
    <div
      x-show="showConfigModal"
      @click.self="showConfigModal = false"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      x-cloak
    >
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Configure Node</h3>
            <button @click="showConfigModal = false" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <template x-if="currentNode && currentNode.node_type === 'llm'">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-2">Model</label>
                <select x-model="currentNode.config.model" class="w-full px-4 py-2 border rounded-lg">
                  <option value="gpt-4o">GPT-4o</option>
                  <option value="gpt-4o-mini">GPT-4o Mini</option>
                  <option value="gpt-4-turbo">GPT-4 Turbo</option>
                  <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">System Prompt</label>
                <textarea
                  x-model="currentNode.config.system_prompt"
                  rows="4"
                  class="w-full px-4 py-2 border rounded-lg"
                  placeholder="You are a helpful assistant..."
                ></textarea>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Temperature</label>
                  <input type="number" x-model.number="currentNode.config.temperature" min="0" max="2" step="0.1" class="w-full px-4 py-2 border rounded-lg" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Max Tokens</label>
                  <input type="number" x-model.number="currentNode.config.max_tokens" min="1" max="4000" class="w-full px-4 py-2 border rounded-lg" />
                </div>
              </div>
            </div>
          </template>

          <template x-if="currentNode && currentNode.node_type === 'function'">
            <div>
              <label class="block text-sm font-medium mb-2">Python Code</label>
              <textarea
                x-model="currentNode.config.code"
                rows="12"
                class="w-full px-4 py-2 border rounded-lg font-mono text-sm"
                placeholder="# Input: 'input' variable&#10;# Output: set 'output' variable&#10;&#10;output = input.upper()"
              ></textarea>
            </div>
          </template>

          <div class="mt-6 flex justify-end space-x-2">
            <button @click="showConfigModal = false" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
              Cancel
            </button>
            <button @click="showConfigModal = false" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
              Done
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script src="/static/plugins/langgraph/js/visual-editor.js"></script>
</body>
</html>
