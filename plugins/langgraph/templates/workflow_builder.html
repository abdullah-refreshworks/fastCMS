<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workflow Builder - LangGraph</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    [x-cloak] { display: none !important; }

    .node-card {
      cursor: move;
      transition: all 0.2s;
    }

    .node-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .node-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-center;
      font-size: 20px;
    }
  </style>
</head>

<body class="h-screen overflow-hidden bg-gray-50">
  <div class="h-full flex flex-col" x-data="workflowBuilder">
    <!-- Toolbar -->
    <div class="bg-white border-b px-4 py-3 flex items-center justify-between shadow-sm">
      <div class="flex items-center space-x-4">
        <a href="/admin/langgraph" class="text-gray-600 hover:text-gray-900 transition-colors">
          <i class="fas fa-arrow-left text-lg"></i>
        </a>
        <input
          type="text"
          x-model="workflow.name"
          class="text-xl font-bold border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded px-2"
          placeholder="Untitled Workflow"
        />
      </div>

      <div class="flex items-center space-x-2">
        <button
          @click="saveWorkflow()"
          class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center"
        >
          <i class="fas fa-save mr-2"></i>Save
        </button>
        <button
          @click="executeWorkflow()"
          :disabled="nodes.length === 0"
          :class="nodes.length === 0 ? 'opacity-50 cursor-not-allowed' : ''"
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center"
        >
          <i class="fas fa-play mr-2"></i>Run
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
      <!-- Sidebar - Node Palette -->
      <div class="w-64 bg-white border-r p-4 overflow-y-auto">
        <h3 class="text-lg font-bold mb-4">Add Nodes</h3>

        <div class="space-y-2">
          <button
            @click="addNode('llm')"
            class="w-full p-3 bg-purple-50 border-2 border-purple-200 rounded-lg hover:bg-purple-100 transition-colors flex items-center"
          >
            <div class="node-icon bg-purple-500 text-white mr-3">
              <i class="fas fa-brain"></i>
            </div>
            <div class="text-left">
              <div class="font-semibold text-gray-900">LLM Node</div>
              <div class="text-xs text-gray-600">OpenAI GPT</div>
            </div>
          </button>

          <button
            @click="addNode('function')"
            class="w-full p-3 bg-blue-50 border-2 border-blue-200 rounded-lg hover:bg-blue-100 transition-colors flex items-center"
          >
            <div class="node-icon bg-blue-500 text-white mr-3">
              <i class="fas fa-code"></i>
            </div>
            <div class="text-left">
              <div class="font-semibold text-gray-900">Function</div>
              <div class="text-xs text-gray-600">Python code</div>
            </div>
          </button>

          <button
            @click="addNode('start')"
            class="w-full p-3 bg-green-50 border-2 border-green-200 rounded-lg hover:bg-green-100 transition-colors flex items-center"
          >
            <div class="node-icon bg-green-500 text-white mr-3">
              <i class="fas fa-play"></i>
            </div>
            <div class="text-left">
              <div class="font-semibold text-gray-900">Start</div>
              <div class="text-xs text-gray-600">Entry point</div>
            </div>
          </button>

          <button
            @click="addNode('end')"
            class="w-full p-3 bg-red-50 border-2 border-red-200 rounded-lg hover:bg-red-100 transition-colors flex items-center"
          >
            <div class="node-icon bg-red-500 text-white mr-3">
              <i class="fas fa-stop"></i>
            </div>
            <div class="text-left">
              <div class="font-semibold text-gray-900">End</div>
              <div class="text-xs text-gray-600">Exit point</div>
            </div>
          </button>
        </div>
      </div>

      <!-- Canvas Area -->
      <div class="flex-1 overflow-auto p-8">
        <div class="space-y-4">
          <template x-for="(node, index) in nodes" :key="node.id">
            <div class="node-card bg-white rounded-lg shadow border-2 border-gray-200 p-4 max-w-md">
              <div class="flex items-start justify-between mb-4">
                <div class="flex items-center">
                  <div :class="`node-icon bg-${getNodeColor(node.node_type)}-500 text-white mr-3`">
                    <i :class="`fas fa-${getNodeIcon(node.node_type)}`"></i>
                  </div>
                  <div>
                    <input
                      type="text"
                      x-model="node.label"
                      class="font-semibold text-gray-900 border-b border-transparent hover:border-gray-300 focus:outline-none focus:border-indigo-500"
                      placeholder="Node Label"
                    />
                    <div class="text-xs text-gray-600" x-text="`${node.node_type} node`"></div>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <button
                    @click="configureNode(index)"
                    class="text-gray-400 hover:text-indigo-600"
                  >
                    <i class="fas fa-cog"></i>
                  </button>
                  <button
                    @click="deleteNode(index)"
                    class="text-gray-400 hover:text-red-600"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>

              <!-- Node Preview -->
              <div class="text-sm text-gray-600 bg-gray-50 rounded p-2" x-show="node.config && Object.keys(node.config).length > 0">
                <template x-if="node.node_type === 'llm'">
                  <div>
                    <div><strong>Model:</strong> <span x-text="node.config.model || 'gpt-4o-mini'"></span></div>
                    <div><strong>System:</strong> <span x-text="(node.config.system_prompt || '').substring(0, 50)"></span>...</div>
                  </div>
                </template>
              </div>

              <!-- Connect Button -->
              <div class="mt-4" x-show="index < nodes.length - 1">
                <div class="text-center">
                  <i class="fas fa-arrow-down text-gray-400"></i>
                </div>
              </div>
            </div>
          </template>

          <!-- Empty State -->
          <div x-show="nodes.length === 0" class="text-center py-12">
            <i class="fas fa-project-diagram text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No nodes yet</h3>
            <p class="text-gray-500">Add nodes from the sidebar to build your workflow</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Node Configuration Modal -->
    <div
      x-show="showConfigModal"
      @click.self="showConfigModal = false"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      x-cloak
    >
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Configure Node</h3>
            <button @click="showConfigModal = false" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <template x-if="currentNode && currentNode.node_type === 'llm'">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                <select
                  x-model="currentNode.config.model"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
                  <option value="gpt-4o">GPT-4o</option>
                  <option value="gpt-4o-mini">GPT-4o Mini</option>
                  <option value="gpt-4-turbo">GPT-4 Turbo</option>
                  <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">System Prompt</label>
                <textarea
                  x-model="currentNode.config.system_prompt"
                  rows="4"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="You are a helpful assistant..."
                ></textarea>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Temperature</label>
                  <input
                    type="number"
                    x-model.number="currentNode.config.temperature"
                    min="0"
                    max="2"
                    step="0.1"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Max Tokens</label>
                  <input
                    type="number"
                    x-model.number="currentNode.config.max_tokens"
                    min="1"
                    max="4000"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  />
                </div>
              </div>
            </div>
          </template>

          <template x-if="currentNode && currentNode.node_type === 'function'">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Python Code</label>
                <textarea
                  x-model="currentNode.config.code"
                  rows="10"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
                  placeholder="# Input is available as 'input' variable&#10;# Set 'output' variable with your result&#10;&#10;output = input.upper()"
                ></textarea>
              </div>
            </div>
          </template>

          <div class="mt-6 flex justify-end">
            <button
              @click="showConfigModal = false"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
            >
              Done
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // Utility functions
    const API_BASE = "/api/v1";

    function showToast(message, type = "info") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      const colors = {
        success: "bg-green-500",
        error: "bg-red-500",
        info: "bg-blue-500",
        warning: "bg-yellow-500",
      };

      toast.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300`;
      toast.textContent = message;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    async function apiRequest(endpoint, options = {}) {
      const token = localStorage.getItem("access_token");
      const headers = {
        "Content-Type": "application/json",
        ...(token && { Authorization: `Bearer ${token}` }),
        ...options.headers,
      };

      const response = await fetch(API_BASE + endpoint, {
        ...options,
        headers,
      });

      if (response.status === 401) {
        localStorage.removeItem("access_token");
        window.location.href = "/admin/login";
        return null;
      }

      if (response.status === 204) return null;

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || data.detail || "Request failed");
      }

      return data;
    }

    // Alpine.js workflow builder
    document.addEventListener('alpine:init', () => {
      Alpine.data('workflowBuilder', () => ({
        workflow: {
          id: '{{ workflow_id if workflow_id else None }}',
          name: '',
          description: '',
        },
        nodes: [],
        edges: [],
        showConfigModal: false,
        currentNode: null,
        currentNodeIndex: null,

        async init() {
          // Load workflow if editing existing
          if (this.workflow.id && this.workflow.id !== 'None') {
            await this.loadWorkflow(this.workflow.id);
          }
        },

        async loadWorkflow(id) {
          try {
            const data = await apiRequest(`/plugins/langgraph/workflows/${id}`);
            this.workflow = data;

            // Load nodes
            const nodesData = await apiRequest(`/plugins/langgraph/workflows/${id}/nodes`);
            this.nodes = nodesData.nodes || [];

            // Load edges
            const edgesData = await apiRequest(`/plugins/langgraph/workflows/${id}/edges`);
            this.edges = edgesData.edges || [];

            showToast('Workflow loaded', 'success');
          } catch (error) {
            showToast('Failed to load workflow: ' + error.message, 'error');
          }
        },

        addNode(type) {
          const node = {
            id: 'temp_' + Date.now(),
            node_type: type,
            label: `${type.charAt(0).toUpperCase() + type.slice(1)} Node`,
            position_x: 0,
            position_y: this.nodes.length * 200,
            config: type === 'llm' ? {
              model: 'gpt-4o-mini',
              system_prompt: 'You are a helpful assistant.',
              temperature: 0.7,
              max_tokens: 1000,
            } : type === 'function' ? {
              code: '# Input is available as \'input\' variable\n# Set \'output\' variable with your result\n\noutput = input'
            } : {}
          };

          this.nodes.push(node);

          // Auto-connect to previous node
          if (this.nodes.length > 1) {
            const prevNode = this.nodes[this.nodes.length - 2];
            this.edges.push({
              id: 'temp_edge_' + Date.now(),
              source_node_id: prevNode.id,
              target_node_id: node.id,
            });
          }

          showToast('Node added', 'success');
        },

        configureNode(index) {
          this.currentNodeIndex = index;
          this.currentNode = this.nodes[index];
          this.showConfigModal = true;
        },

        deleteNode(index) {
          if (!confirm('Delete this node?')) return;

          const nodeId = this.nodes[index].id;
          this.nodes.splice(index, 1);

          // Remove connected edges
          this.edges = this.edges.filter(e =>
            e.source_node_id !== nodeId && e.target_node_id !== nodeId
          );

          showToast('Node deleted', 'success');
        },

        getNodeColor(type) {
          const colors = {
            llm: 'purple',
            function: 'blue',
            start: 'green',
            end: 'red',
            tool: 'yellow',
          };
          return colors[type] || 'gray';
        },

        getNodeIcon(type) {
          const icons = {
            llm: 'brain',
            function: 'code',
            start: 'play',
            end: 'stop',
            tool: 'wrench',
          };
          return icons[type] || 'circle';
        },

        async saveWorkflow() {
          try {
            if (!this.workflow.name || this.workflow.name.trim() === '') {
              showToast('Please enter a workflow name', 'warning');
              return;
            }

            // Save or create workflow
            const method = this.workflow.id && this.workflow.id !== 'None' ? 'PUT' : 'POST';
            const url = this.workflow.id && this.workflow.id !== 'None'
              ? `/plugins/langgraph/workflows/${this.workflow.id}`
              : '/plugins/langgraph/workflows';

            const response = await apiRequest(url, {
              method,
              body: JSON.stringify({
                name: this.workflow.name.trim(),
                description: this.workflow.description || '',
                tags: [],
                is_template: false,
                rete_data: {}
              })
            });

            if (response) {
              this.workflow.id = response.id;

              // Save nodes
              for (const node of this.nodes) {
                if (node.id.startsWith('temp_')) {
                  // Create new node
                  const nodeResponse = await apiRequest(
                    `/plugins/langgraph/workflows/${this.workflow.id}/nodes`,
                    {
                      method: 'POST',
                      body: JSON.stringify({
                        workflow_id: this.workflow.id,
                        node_type: node.node_type,
                        label: node.label,
                        position_x: node.position_x,
                        position_y: node.position_y,
                        config: node.config,
                      })
                    }
                  );
                  // Update temp ID with real ID
                  const oldId = node.id;
                  node.id = nodeResponse.id;
                  // Update edges that reference this node
                  this.edges.forEach(edge => {
                    if (edge.source_node_id === oldId) edge.source_node_id = node.id;
                    if (edge.target_node_id === oldId) edge.target_node_id = node.id;
                  });
                }
              }

              // Save edges
              for (const edge of this.edges) {
                if (edge.id.startsWith('temp_')) {
                  await apiRequest(
                    `/plugins/langgraph/workflows/${this.workflow.id}/edges`,
                    {
                      method: 'POST',
                      body: JSON.stringify({
                        workflow_id: this.workflow.id,
                        source_node_id: edge.source_node_id,
                        target_node_id: edge.target_node_id,
                      })
                    }
                  );
                }
              }

              showToast('Workflow saved successfully!', 'success');
            }
          } catch (error) {
            showToast('Failed to save: ' + error.message, 'error');
          }
        },

        async executeWorkflow() {
          if (!this.workflow.id || this.workflow.id === 'None') {
            showToast('Please save the workflow first', 'warning');
            return;
          }

          if (this.nodes.length === 0) {
            showToast('Add at least one node to execute', 'warning');
            return;
          }

          const input = prompt('Enter input for workflow:');
          if (input === null) return;

          try {
            showToast('Executing workflow...', 'info');

            const result = await apiRequest(`/plugins/langgraph/workflows/${this.workflow.id}/execute`, {
              method: 'POST',
              body: JSON.stringify({ input })
            });

            showToast('Workflow executed!', 'success');

            // Show results
            alert(
              `Status: ${result.status}\n\n` +
              `Output: ${JSON.stringify(result.output_data, null, 2)}\n\n` +
              `Logs: ${result.execution_log.length} events`
            );

          } catch (error) {
            showToast('Execution failed: ' + error.message, 'error');
          }
        }
      }));
    });
  </script>
</body>
</html>
