{% extends "base.html" %}

{% block title %}Langflow - AI Workflows{% endblock %}

{% block content %}
<div x-data="langflowPage()" x-init="init()" class="langflow-container">
  <!-- Minimal Header with Connection Status -->
  <div class="px-4 py-2 bg-white border-b flex items-center justify-between">
    <div class="flex items-center space-x-4">
      <h1 class="text-lg font-semibold text-gray-900">
        <i class="fas fa-project-diagram text-purple-600 mr-2"></i>
        Langflow
      </h1>
      <!-- Connection Status -->
      <div class="flex items-center space-x-2">
        <div
          :class="connected ? 'bg-green-500' : checking ? 'bg-yellow-500 animate-pulse' : 'bg-red-500'"
          class="h-2.5 w-2.5 rounded-full"
        ></div>
        <span class="text-sm text-gray-600" x-text="checking ? 'Connecting...' : (connected ? 'Connected' : 'Disconnected')"></span>
      </div>
    </div>
    <div class="flex items-center space-x-3">
      <button
        @click="checkConnection"
        :disabled="checking"
        class="inline-flex items-center px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 disabled:opacity-50"
      >
        <i class="fas fa-sync-alt mr-1.5" :class="checking && 'animate-spin'"></i>
        Refresh
      </button>
      <a
        href="{{ langflow_url }}"
        target="_blank"
        class="inline-flex items-center px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900"
      >
        <i class="fas fa-external-link-alt mr-1.5"></i>
        Open in New Tab
      </a>
    </div>
  </div>

  <!-- Error Message (shown when not connected) -->
  <div x-show="!connected && !checking" x-cloak class="bg-amber-50 border-b border-amber-200 px-4 py-3">
    <div class="flex items-center">
      <i class="fas fa-exclamation-triangle text-amber-500 mr-3"></i>
      <div class="flex-1">
        <span class="text-sm text-amber-800" x-text="error || 'Unable to connect to Langflow'"></span>
        <span class="text-sm text-amber-600 ml-2">
          Start Langflow with: <code class="bg-amber-100 px-1.5 py-0.5 rounded text-xs">docker run -d -p 7860:7860 langflowai/langflow:latest</code>
        </span>
      </div>
    </div>
  </div>

  <!-- Full Width Langflow Editor -->
  <div x-show="connected" x-cloak class="langflow-iframe-wrapper">
    <iframe
      src="{{ langflow_url }}"
      class="w-full h-full border-0"
      allow="clipboard-read; clipboard-write"
    ></iframe>
  </div>

  <!-- Placeholder when not connected -->
  <div x-show="!connected" class="langflow-placeholder">
    <div class="text-center">
      <i class="fas fa-plug text-6xl text-gray-300 mb-4"></i>
      <p class="text-gray-500">Connect to Langflow to start building workflows</p>
    </div>
  </div>
</div>

<style>
  /* Remove padding from parent container for langflow page */
  .langflow-container {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 256px; /* Sidebar width (w-64 = 16rem = 256px) */
    display: flex;
    flex-direction: column;
    background: #f9fafb;
  }

  /* On mobile, sidebar is hidden so use full width */
  @media (max-width: 1023px) {
    .langflow-container {
      left: 0;
      top: 64px; /* Account for mobile header */
    }
  }

  .langflow-iframe-wrapper {
    flex: 1;
    min-height: 0;
    position: relative;
  }

  .langflow-iframe-wrapper iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .langflow-placeholder {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  [x-cloak] {
    display: none !important;
  }
</style>

<script>
function langflowPage() {
  return {
    connected: false,
    checking: false,
    error: null,

    async init() {
      await this.checkConnection();
    },

    async checkConnection() {
      this.checking = true;
      this.error = null;
      try {
        const response = await fetch('/api/v1/plugins/langflow/health');
        const data = await response.json();
        this.connected = data.status === 'connected';
        if (!this.connected) {
          this.error = data.error || 'Unable to connect to Langflow';
        }
      } catch (e) {
        this.connected = false;
        this.error = 'Failed to check connection';
      }
      this.checking = false;
    }
  };
}
</script>
{% endblock %}
